name: Navigation Testing CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run smoke tests weekly on Sundays at 6 AM UTC
    - cron: '0 6 * * 0'

jobs:
  unit-tests:
    name: Unit & Component Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-
            ${{ runner.os }}-node-
            
      - name: Install dependencies
        run: npm ci
        
      - name: Lint code
        run: npm run lint
        
      - name: Run unit tests with coverage
        run: npm run test:coverage
        env:
          CI: true
          NODE_ENV: test
          
      - name: Check coverage thresholds
        run: |
          # Ensure navigation components have >= 90% coverage
          npx nyc check-coverage --lines 90 --functions 90 --branches 85 --statements 90
          
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unit-tests
          name: navigation-unit-tests
          fail_ci_if_error: true
          
      - name: Generate coverage report
        run: npm run test:coverage -- --reporter=html
        
      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.node-version }}
          path: coverage/
          retention-days: 7

  accessibility-tests:
    name: Accessibility Testing
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run accessibility tests
        run: npm run test -- --testNamePattern="accessibility"
        env:
          CI: true
          NODE_ENV: test
          
      - name: Check for critical accessibility violations
        run: |
          # Fail build if any critical a11y violations are found
          if grep -r "violation.*critical" coverage/; then
            echo "Critical accessibility violations found!"
            exit 1
          fi

  e2e-tests:
    name: E2E Navigation Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    strategy:
      matrix:
        browser: [chrome, firefox, edge]
        viewport: [desktop, tablet, mobile]
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Cypress
        run: npx cypress install
        
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Start application server
        run: |
          npm run preview &
          npx wait-on http://localhost:4173 --timeout 60000
        env:
          NODE_ENV: production
          
      - name: Run Cypress E2E tests
        uses: cypress-io/github-action@v6
        with:
          browser: ${{ matrix.browser }}
          spec: cypress/e2e/navigation-*.cy.ts
          config: viewportWidth=1280,viewportHeight=720
          record: false
          parallel: true
          group: 'E2E-${{ matrix.browser }}-${{ matrix.viewport }}'
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_ENV: test
          
      - name: Upload Cypress screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots-${{ matrix.browser }}-${{ matrix.viewport }}
          path: cypress/screenshots/
          retention-days: 7
          
      - name: Upload Cypress videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos-${{ matrix.browser }}-${{ matrix.viewport }}
          path: cypress/videos/
          retention-days: 3

  performance-tests:
    name: Navigation Performance Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: '.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
          
      - name: Run performance benchmarks
        run: npm run test -- --testNamePattern="performance"
        env:
          CI: true
          NODE_ENV: test

  smoke-tests:
    name: Weekly Smoke Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run smoke tests against production
        run: npx cypress run --spec "cypress/e2e/smoke-tests.cy.ts"
        env:
          CYPRESS_BASE_URL: ${{ secrets.PRODUCTION_URL }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          NODE_ENV: production

  report-results:
    name: Test Results & Notifications
    runs-on: ubuntu-latest
    needs: [unit-tests, accessibility-tests, e2e-tests, performance-tests]
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Generate test report
        run: |
          echo "## Navigation Test Results" >> test_report.md
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> test_report.md
          echo "- Accessibility Tests: ${{ needs.accessibility-tests.result }}" >> test_report.md
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> test_report.md
          echo "- Performance Tests: ${{ needs.performance-tests.result }}" >> test_report.md
          
      - name: Comment test results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('test_report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
            
      - name: Send Slack notification on failure
        if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Navigation tests failed in ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            Failed jobs:
            - Unit Tests: ${{ needs.unit-tests.result }}
            - Accessibility: ${{ needs.accessibility-tests.result }}
            - E2E Tests: ${{ needs.e2e-tests.result }}
            - Performance: ${{ needs.performance-tests.result }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: Create GitHub issue on critical failure
        if: failure() && contains(needs.*.result, 'failure') && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Critical Navigation Test Failure - ${{ github.run_number }}',
              body: `
                Critical navigation test failure detected in main branch.
                
                **Run Details:**
                - Workflow: ${{ github.workflow }}
                - Run ID: ${{ github.run_id }}
                - Commit: ${{ github.sha }}
                - Author: ${{ github.actor }}
                
                **Failed Jobs:**
                - Unit Tests: ${{ needs.unit-tests.result }}
                - Accessibility: ${{ needs.accessibility-tests.result }}
                - E2E Tests: ${{ needs.e2e-tests.result }}
                - Performance: ${{ needs.performance-tests.result }}
                
                Please investigate and fix immediately.
              `,
              labels: ['bug', 'critical', 'navigation', 'ci-failure'],
              assignees: ['${{ github.actor }}']
            });

  deploy-test-reports:
    name: Deploy Test Reports
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-20.x
          path: ./coverage-reports/
          
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage-reports/
          destination_dir: navigation-test-reports
          
      - name: Update README with coverage badge
        run: |
          # This would update the README with current coverage percentage
          echo "Coverage reports deployed to GitHub Pages"