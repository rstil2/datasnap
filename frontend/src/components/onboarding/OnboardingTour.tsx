import React, { useState, useEffect, useRef, createContext, useContext, ReactNode } from 'react';
import { ChevronLeft, ChevronRight, X, Play, Pause, SkipForward } from 'lucide-react';
import { useFocusTrap, useScreenReaderAnnouncement } from '../../utils/accessibility';

export interface TourStep {
  id: string;
  title: string;
  content: ReactNode;
  target: string; // CSS selector
  position?: 'top' | 'bottom' | 'left' | 'right' | 'center';
  spotlight?: boolean;
  interactive?: boolean;
  beforeStep?: () => Promise<void> | void;
  afterStep?: () => Promise<void> | void;
  condition?: () => boolean;
  optional?: boolean;
}

export interface Tour {
  id: string;
  name: string;
  description: string;
  steps: TourStep[];
  category: 'onboarding' | 'feature' | 'advanced';
  estimatedDuration: number; // in minutes
  prerequisites?: string[];
  completionRewards?: string[];
}

export interface TourContextType {
  currentTour: Tour | null;
  currentStepIndex: number;
  isActive: boolean;
  isPaused: boolean;
  startTour: (tourId: string) => void;
  stopTour: () => void;
  pauseTour: () => void;
  resumeTour: () => void;
  nextStep: () => void;
  previousStep: () => void;
  skipTour: () => void;
  registerTour: (tour: Tour) => void;
  completedTours: string[];
  markTourCompleted: (tourId: string) => void;
}

const TourContext = createContext<TourContextType | undefined>(undefined);

export const useTour = (): TourContextType => {
  const context = useContext(TourContext);
  if (!context) {
    throw new Error('useTour must be used within a TourProvider');
  }
  return context;
};

// Default tours
const defaultTours: Tour[] = [
  {
    id: 'welcome-tour',
    name: 'Welcome to DataSnap',
    description: 'Get started with the basics of DataSnap',
    category: 'onboarding',
    estimatedDuration: 5,
    steps: [
      {
        id: 'welcome',
        title: 'Welcome to DataSnap! ðŸŽ‰',
        content: (\n          <div>\n            <p>Welcome to DataSnap, your all-in-one data analysis and visualization platform!</p>\n            <p>This quick tour will show you the key features to get you started.</p>\n            <ul className=\"mt-3 space-y-1\">\n              <li>â€¢ Import and explore your data</li>\n              <li>â€¢ Create beautiful visualizations</li>\n              <li>â€¢ Transform and clean your datasets</li>\n              <li>â€¢ Share your insights</li>\n            </ul>\n          </div>\n        ),\n        target: 'body',\n        position: 'center'\n      },\n      {\n        id: 'navigation',\n        title: 'Main Navigation',\n        content: (\n          <div>\n            <p>This is your main navigation bar. From here you can:</p>\n            <ul className=\"mt-2 space-y-1\">\n              <li>â€¢ Access different sections of the app</li>\n              <li>â€¢ Switch between projects</li>\n              <li>â€¢ Access your profile and settings</li>\n            </ul>\n          </div>\n        ),\n        target: 'nav, header, [role=\"navigation\"]',\n        position: 'bottom'\n      },\n      {\n        id: 'data-import',\n        title: 'Import Your Data',\n        content: (\n          <div>\n            <p>Click here to import your data. We support:</p>\n            <ul className=\"mt-2 space-y-1\">\n              <li>â€¢ CSV files</li>\n              <li>â€¢ Excel spreadsheets</li>\n              <li>â€¢ JSON data</li>\n              <li>â€¢ Database connections</li>\n            </ul>\n            <p className=\"mt-2 text-sm text-gray-600 dark:text-gray-400\">\n              Try uploading a sample CSV to get started!\n            </p>\n          </div>\n        ),\n        target: '[data-tour=\"import-button\"], .import-button, button[aria-label*=\"import\"], button[aria-label*=\"Import\"]',\n        position: 'bottom'\n      },\n      {\n        id: 'data-table',\n        title: 'Data Table View',\n        content: (\n          <div>\n            <p>Once you've imported data, it will appear here in a table view.</p>\n            <p>You can:</p>\n            <ul className=\"mt-2 space-y-1\">\n              <li>â€¢ Sort and filter columns</li>\n              <li>â€¢ Select rows for analysis</li>\n              <li>â€¢ Preview data quality</li>\n            </ul>\n          </div>\n        ),\n        target: 'table, .data-table, [role=\"table\"]',\n        position: 'top',\n        condition: () => !!document.querySelector('table, .data-table, [role=\"table\"]')\n      },\n      {\n        id: 'create-chart',\n        title: 'Create Visualizations',\n        content: (\n          <div>\n            <p>Transform your data into beautiful charts and graphs.</p>\n            <p>Our AI assistant will suggest the best chart type for your data!</p>\n          </div>\n        ),\n        target: '[data-tour=\"chart-button\"], .chart-button, button[aria-label*=\"chart\"], button[aria-label*=\"Chart\"]',\n        position: 'bottom'\n      },\n      {\n        id: 'completion',\n        title: 'You\\'re All Set! ðŸš€',\n        content: (\n          <div>\n            <p>Congratulations! You've completed the welcome tour.</p>\n            <p>You now know how to:</p>\n            <ul className=\"mt-2 space-y-1\">\n              <li>âœ“ Navigate the interface</li>\n              <li>âœ“ Import your data</li>\n              <li>âœ“ Create visualizations</li>\n            </ul>\n            <p className=\"mt-3 text-sm font-medium\">\n              Ready to explore your data? Start by importing a file!\n            </p>\n          </div>\n        ),\n        target: 'body',\n        position: 'center'\n      }\n    ]\n  },\n  {\n    id: 'chart-creation-tour',\n    name: 'Chart Creation Master Class',\n    description: 'Learn to create stunning visualizations',\n    category: 'feature',\n    estimatedDuration: 8,\n    prerequisites: ['welcome-tour'],\n    steps: [\n      {\n        id: 'chart-types',\n        title: 'Chart Types Overview',\n        content: (\n          <div>\n            <p>DataSnap offers many chart types for different data stories:</p>\n            <ul className=\"mt-2 space-y-1\">\n              <li>â€¢ <strong>Bar Charts:</strong> Compare categories</li>\n              <li>â€¢ <strong>Line Charts:</strong> Show trends over time</li>\n              <li>â€¢ <strong>Scatter Plots:</strong> Explore relationships</li>\n              <li>â€¢ <strong>Pie Charts:</strong> Show proportions</li>\n              <li>â€¢ <strong>Advanced:</strong> Violin plots, Radar charts, and more!</li>\n            </ul>\n          </div>\n        ),\n        target: '.chart-type-selector',\n        position: 'right'\n      }\n    ]\n  },\n  {\n    id: 'data-transformation-tour',\n    name: 'Data Transformation Pipeline',\n    description: 'Master data cleaning and transformation',\n    category: 'advanced',\n    estimatedDuration: 12,\n    prerequisites: ['welcome-tour', 'chart-creation-tour'],\n    steps: [\n      {\n        id: 'pipeline-intro',\n        title: 'Visual Data Pipeline',\n        content: (\n          <div>\n            <p>Build powerful data transformation pipelines visually:</p>\n            <ul className=\"mt-2 space-y-1\">\n              <li>â€¢ Drag and drop transformation steps</li>\n              <li>â€¢ Real-time preview of results</li>\n              <li>â€¢ Save and reuse pipelines</li>\n            </ul>\n          </div>\n        ),\n        target: '.transformation-pipeline, [data-tour=\"pipeline\"]',\n        position: 'top'\n      }\n    ]\n  }\n];\n\nexport interface TourProviderProps {\n  children: ReactNode;\n  tours?: Tour[];\n  onTourComplete?: (tourId: string) => void;\n  autoStart?: string; // Tour ID to auto-start\n}\n\nexport const TourProvider: React.FC<TourProviderProps> = ({\n  children,\n  tours = defaultTours,\n  onTourComplete,\n  autoStart\n}) => {\n  const [registeredTours, setRegisteredTours] = useState<Map<string, Tour>>(\n    new Map(tours.map(tour => [tour.id, tour]))\n  );\n  const [currentTour, setCurrentTour] = useState<Tour | null>(null);\n  const [currentStepIndex, setCurrentStepIndex] = useState(0);\n  const [isActive, setIsActive] = useState(false);\n  const [isPaused, setIsPaused] = useState(false);\n  const [completedTours, setCompletedTours] = useState<string[]>(() => {\n    try {\n      const stored = localStorage.getItem('datasnap-completed-tours');\n      return stored ? JSON.parse(stored) : [];\n    } catch {\n      return [];\n    }\n  });\n\n  // Auto-start tour if specified\n  useEffect(() => {\n    if (autoStart && !completedTours.includes(autoStart)) {\n      const timer = setTimeout(() => {\n        startTour(autoStart);\n      }, 1000); // Delay to allow page to load\n      return () => clearTimeout(timer);\n    }\n  }, [autoStart, completedTours]);\n\n  const startTour = (tourId: string) => {\n    const tour = registeredTours.get(tourId);\n    if (!tour) {\n      console.warn(`Tour with id \"${tourId}\" not found`);\n      return;\n    }\n\n    // Check prerequisites\n    if (tour.prerequisites) {\n      const unmetPrerequisites = tour.prerequisites.filter(\n        prereq => !completedTours.includes(prereq)\n      );\n      \n      if (unmetPrerequisites.length > 0) {\n        console.warn(`Tour \"${tourId}\" requires completing: ${unmetPrerequisites.join(', ')}`);\n        return;\n      }\n    }\n\n    setCurrentTour(tour);\n    setCurrentStepIndex(0);\n    setIsActive(true);\n    setIsPaused(false);\n\n    // Execute before step hook for first step\n    const firstStep = tour.steps[0];\n    if (firstStep?.beforeStep) {\n      Promise.resolve(firstStep.beforeStep()).catch(console.error);\n    }\n  };\n\n  const stopTour = () => {\n    if (currentTour) {\n      // Execute after step hook for current step\n      const currentStep = currentTour.steps[currentStepIndex];\n      if (currentStep?.afterStep) {\n        Promise.resolve(currentStep.afterStep()).catch(console.error);\n      }\n    }\n\n    setCurrentTour(null);\n    setCurrentStepIndex(0);\n    setIsActive(false);\n    setIsPaused(false);\n  };\n\n  const pauseTour = () => {\n    setIsPaused(true);\n  };\n\n  const resumeTour = () => {\n    setIsPaused(false);\n  };\n\n  const nextStep = async () => {\n    if (!currentTour) return;\n\n    // Execute after step hook for current step\n    const currentStep = currentTour.steps[currentStepIndex];\n    if (currentStep?.afterStep) {\n      await Promise.resolve(currentStep.afterStep()).catch(console.error);\n    }\n\n    const nextIndex = currentStepIndex + 1;\n    \n    if (nextIndex >= currentTour.steps.length) {\n      // Tour completed\n      markTourCompleted(currentTour.id);\n      if (onTourComplete) {\n        onTourComplete(currentTour.id);\n      }\n      stopTour();\n      return;\n    }\n\n    // Check if next step's condition is met\n    const nextStep = currentTour.steps[nextIndex];\n    if (nextStep.condition && !nextStep.condition()) {\n      // Skip this step and try the next one\n      setCurrentStepIndex(nextIndex);\n      setTimeout(() => {\n        nextStep();\n      }, 100);\n      return;\n    }\n\n    setCurrentStepIndex(nextIndex);\n\n    // Execute before step hook for next step\n    if (nextStep.beforeStep) {\n      await Promise.resolve(nextStep.beforeStep()).catch(console.error);\n    }\n  };\n\n  const previousStep = async () => {\n    if (!currentTour || currentStepIndex <= 0) return;\n\n    // Execute after step hook for current step\n    const currentStep = currentTour.steps[currentStepIndex];\n    if (currentStep?.afterStep) {\n      await Promise.resolve(currentStep.afterStep()).catch(console.error);\n    }\n\n    const prevIndex = currentStepIndex - 1;\n    setCurrentStepIndex(prevIndex);\n\n    // Execute before step hook for previous step\n    const prevStep = currentTour.steps[prevIndex];\n    if (prevStep?.beforeStep) {\n      await Promise.resolve(prevStep.beforeStep()).catch(console.error);\n    }\n  };\n\n  const skipTour = () => {\n    if (currentTour) {\n      markTourCompleted(currentTour.id);\n      if (onTourComplete) {\n        onTourComplete(currentTour.id);\n      }\n    }\n    stopTour();\n  };\n\n  const registerTour = (tour: Tour) => {\n    setRegisteredTours(prev => new Map(prev.set(tour.id, tour)));\n  };\n\n  const markTourCompleted = (tourId: string) => {\n    const newCompleted = [...completedTours, tourId];\n    setCompletedTours(newCompleted);\n    try {\n      localStorage.setItem('datasnap-completed-tours', JSON.stringify(newCompleted));\n    } catch (error) {\n      console.warn('Failed to save completed tours:', error);\n    }\n  };\n\n  const value: TourContextType = {\n    currentTour,\n    currentStepIndex,\n    isActive,\n    isPaused,\n    startTour,\n    stopTour,\n    pauseTour,\n    resumeTour,\n    nextStep,\n    previousStep,\n    skipTour,\n    registerTour,\n    completedTours,\n    markTourCompleted\n  };\n\n  return (\n    <TourContext.Provider value={value}>\n      {children}\n      {isActive && <TourOverlay />}\n    </TourContext.Provider>\n  );\n};\n\n// Tour Overlay Component\nconst TourOverlay: React.FC = () => {\n  const { \n    currentTour, \n    currentStepIndex, \n    isPaused, \n    nextStep, \n    previousStep, \n    pauseTour, \n    resumeTour, \n    stopTour, \n    skipTour \n  } = useTour();\n  \n  const overlayRef = useRef<HTMLDivElement>(null);\n  const announce = useScreenReaderAnnouncement();\n\n  useFocusTrap(overlayRef, true, {\n    onEscape: stopTour,\n    returnFocusOnDeactivate: true\n  });\n\n  useEffect(() => {\n    if (currentTour && !isPaused) {\n      const currentStep = currentTour.steps[currentStepIndex];\n      announce(`Tour step ${currentStepIndex + 1} of ${currentTour.steps.length}: ${currentStep.title}`);\n    }\n  }, [currentStepIndex, currentTour, isPaused, announce]);\n\n  if (!currentTour) return null;\n\n  const currentStep = currentTour.steps[currentStepIndex];\n  const isFirstStep = currentStepIndex === 0;\n  const isLastStep = currentStepIndex === currentTour.steps.length - 1;\n\n  const getTargetElement = (): HTMLElement | null => {\n    if (currentStep.target === 'body') return document.body;\n    return document.querySelector(currentStep.target);\n  };\n\n  const getStepPosition = (): React.CSSProperties => {\n    const target = getTargetElement();\n    if (!target || currentStep.position === 'center') {\n      return {\n        position: 'fixed',\n        top: '50%',\n        left: '50%',\n        transform: 'translate(-50%, -50%)'\n      };\n    }\n\n    const rect = target.getBoundingClientRect();\n    const offset = 20;\n    let styles: React.CSSProperties = {\n      position: 'fixed',\n      zIndex: 1001\n    };\n\n    switch (currentStep.position) {\n      case 'top':\n        styles.bottom = `${window.innerHeight - rect.top + offset}px`;\n        styles.left = `${rect.left + rect.width / 2}px`;\n        styles.transform = 'translateX(-50%)';\n        break;\n      case 'bottom':\n        styles.top = `${rect.bottom + offset}px`;\n        styles.left = `${rect.left + rect.width / 2}px`;\n        styles.transform = 'translateX(-50%)';\n        break;\n      case 'left':\n        styles.right = `${window.innerWidth - rect.left + offset}px`;\n        styles.top = `${rect.top + rect.height / 2}px`;\n        styles.transform = 'translateY(-50%)';\n        break;\n      case 'right':\n        styles.left = `${rect.right + offset}px`;\n        styles.top = `${rect.top + rect.height / 2}px`;\n        styles.transform = 'translateY(-50%)';\n        break;\n      default:\n        styles.top = '50%';\n        styles.left = '50%';\n        styles.transform = 'translate(-50%, -50%)';\n    }\n\n    return styles;\n  };\n\n  const getSpotlightStyles = (): React.CSSProperties => {\n    const target = getTargetElement();\n    if (!target || !currentStep.spotlight) return {};\n\n    const rect = target.getBoundingClientRect();\n    const padding = 8;\n    \n    return {\n      position: 'fixed',\n      top: `${rect.top - padding}px`,\n      left: `${rect.left - padding}px`,\n      width: `${rect.width + padding * 2}px`,\n      height: `${rect.height + padding * 2}px`,\n      borderRadius: '8px',\n      boxShadow: '0 0 0 4px rgba(59, 130, 246, 0.5), 0 0 0 9999px rgba(0, 0, 0, 0.5)',\n      zIndex: 1000,\n      pointerEvents: 'none'\n    };\n  };\n\n  return (\n    <div className=\"tour-overlay\">\n      {/* Dark overlay */}\n      <div className=\"fixed inset-0 bg-black bg-opacity-50 z-999\" />\n      \n      {/* Spotlight */}\n      {currentStep.spotlight && (\n        <div style={getSpotlightStyles()} />\n      )}\n\n      {/* Tour step card */}\n      <div\n        ref={overlayRef}\n        className=\"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-sm w-full border border-gray-200 dark:border-gray-700\"\n        style={getStepPosition()}\n        role=\"dialog\"\n        aria-labelledby=\"tour-step-title\"\n        aria-describedby=\"tour-step-content\"\n      >\n        {/* Header */}\n        <div className=\"border-b border-gray-200 dark:border-gray-700 px-4 py-3\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h3 id=\"tour-step-title\" className=\"text-lg font-semibold text-gray-900 dark:text-white\">\n                {currentStep.title}\n              </h3>\n              <div className=\"text-sm text-gray-500 dark:text-gray-400\">\n                Step {currentStepIndex + 1} of {currentTour.steps.length} â€¢ {currentTour.name}\n              </div>\n            </div>\n            <button\n              onClick={stopTour}\n              className=\"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors\"\n              aria-label=\"Close tour\"\n            >\n              <X size={20} />\n            </button>\n          </div>\n        </div>\n\n        {/* Content */}\n        <div className=\"px-4 py-4\">\n          <div id=\"tour-step-content\" className=\"text-gray-700 dark:text-gray-300\">\n            {currentStep.content}\n          </div>\n        </div>\n\n        {/* Controls */}\n        <div className=\"border-t border-gray-200 dark:border-gray-700 px-4 py-3\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              {!isFirstStep && (\n                <button\n                  onClick={previousStep}\n                  className=\"flex items-center gap-1 px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 transition-colors\"\n                >\n                  <ChevronLeft size={16} />\n                  Back\n                </button>\n              )}\n              <button\n                onClick={isPaused ? resumeTour : pauseTour}\n                className=\"flex items-center gap-1 px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 transition-colors\"\n                aria-label={isPaused ? 'Resume tour' : 'Pause tour'}\n              >\n                {isPaused ? <Play size={16} /> : <Pause size={16} />}\n                {isPaused ? 'Resume' : 'Pause'}\n              </button>\n            </div>\n            \n            <div className=\"flex items-center gap-2\">\n              <button\n                onClick={skipTour}\n                className=\"flex items-center gap-1 px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 transition-colors\"\n              >\n                <SkipForward size={16} />\n                Skip Tour\n              </button>\n              <button\n                onClick={nextStep}\n                disabled={isPaused}\n                className=\"flex items-center gap-1 px-4 py-1.5 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white rounded-md transition-colors text-sm font-medium\"\n              >\n                {isLastStep ? 'Finish' : 'Next'}\n                {!isLastStep && <ChevronRight size={16} />}\n              </button>\n            </div>\n          </div>\n          \n          {/* Progress bar */}\n          <div className=\"mt-3\">\n            <div className=\"flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-1\">\n              <span>Progress</span>\n              <span>{Math.round(((currentStepIndex + 1) / currentTour.steps.length) * 100)}%</span>\n            </div>\n            <div className=\"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5\">\n              <div \n                className=\"bg-blue-500 h-1.5 rounded-full transition-all duration-300 ease-out\"\n                style={{ width: `${((currentStepIndex + 1) / currentTour.steps.length) * 100}%` }}\n              />\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\n// Tour Launcher Component\nexport interface TourLauncherProps {\n  tourId: string;\n  children?: ReactNode;\n  className?: string;\n  variant?: 'button' | 'link' | 'card';\n}\n\nexport const TourLauncher: React.FC<TourLauncherProps> = ({\n  tourId,\n  children,\n  className = '',\n  variant = 'button'\n}) => {\n  const { startTour, completedTours } = useTour();\n  const isCompleted = completedTours.includes(tourId);\n\n  const handleClick = () => {\n    startTour(tourId);\n  };\n\n  const baseClasses = {\n    button: 'inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors',\n    link: 'inline-flex items-center gap-1 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors',\n    card: 'block p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-blue-300 dark:hover:border-blue-600 transition-colors cursor-pointer'\n  };\n\n  return (\n    <button\n      onClick={handleClick}\n      className={`${baseClasses[variant]} ${className} ${\n        isCompleted ? 'opacity-75' : ''\n      }`}\n      disabled={isCompleted}\n    >\n      {children || (\n        <>\n          <Play size={16} />\n          Start Tour\n          {isCompleted && ' (Completed)'}\n        </>\n      )}\n    </button>\n  );\n};\n\nexport default TourProvider;